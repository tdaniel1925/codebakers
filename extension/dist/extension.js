"use strict";var M=Object.create;var g=Object.defineProperty;var S=Object.getOwnPropertyDescriptor;var b=Object.getOwnPropertyNames;var I=Object.getPrototypeOf,E=Object.prototype.hasOwnProperty;var A=(o,e)=>{for(var t in e)g(o,t,{get:e[t],enumerable:!0})},P=(o,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of b(e))!E.call(o,a)&&a!==t&&g(o,a,{get:()=>e[a],enumerable:!(s=S(e,a))||s.enumerable});return o};var p=(o,e,t)=>(t=o!=null?M(I(o)):{},P(e||!o||!o.__esModule?g(t,"default",{value:o,enumerable:!0}):t,o)),x=o=>P(g({},"__esModule",{value:!0}),o);var B={};A(B,{activate:()=>W,deactivate:()=>F});module.exports=x(B);var i=p(require("vscode"));var c=p(require("vscode")),r=p(require("fs")),f=p(require("path")),y=class{constructor(){this.workspaceRoot=c.workspace.workspaceFolders?.[0]?.uri.fsPath||"",this.claudeMdPath=f.join(this.workspaceRoot,"CLAUDE.md"),this.cursorRulesPath=f.join(this.workspaceRoot,".cursorrules"),this.claudeFolderPath=f.join(this.workspaceRoot,".claude")}getStatus(){let e=r.existsSync(this.claudeMdPath),t=r.existsSync(this.cursorRulesPath),s=r.existsSync(this.claudeFolderPath),a=0;if(s)try{a=r.readdirSync(this.claudeFolderPath).filter(w=>w.endsWith(".md")).length}catch(h){console.error("Error reading .claude folder:",h)}let n=null;if(e)try{n=r.statSync(this.claudeMdPath).mtime.toISOString()}catch{}let l=!0;if(e&&t)try{let h=r.readFileSync(this.claudeMdPath,"utf-8"),w=r.readFileSync(this.cursorRulesPath,"utf-8");l=h===w}catch{l=!1}else e!==t&&(l=!1);return{hasClaudeMd:e,hasCursorRules:t,hasClaudeFolder:s,patternCount:a,lastUpdated:n,inSync:l}}async syncPatternFiles(){try{let e=r.existsSync(this.claudeMdPath),t=r.existsSync(this.cursorRulesPath);if(e&&!t){let s=r.readFileSync(this.claudeMdPath,"utf-8");return r.writeFileSync(this.cursorRulesPath,s),c.window.showInformationMessage("Synced CLAUDE.md to .cursorrules"),!0}if(!e&&t){let s=r.readFileSync(this.cursorRulesPath,"utf-8");return r.writeFileSync(this.claudeMdPath,s),c.window.showInformationMessage("Synced .cursorrules to CLAUDE.md"),!0}if(e&&t){let s=r.readFileSync(this.claudeMdPath,"utf-8"),a=r.readFileSync(this.cursorRulesPath,"utf-8");return s!==a?(r.writeFileSync(this.cursorRulesPath,s),c.window.showInformationMessage("Synced CLAUDE.md to .cursorrules"),!0):(c.window.showInformationMessage("Pattern files already in sync"),!0)}return c.window.showWarningMessage('No pattern files found. Run "CodeBakers: Initialize Patterns" first.'),!1}catch(e){return console.error("Error syncing pattern files:",e),c.window.showErrorMessage(`Failed to sync pattern files: ${e}`),!1}}async initializePatterns(e){try{if(r.existsSync(this.claudeFolderPath)||r.mkdirSync(this.claudeFolderPath,{recursive:!0}),e&&await this.downloadPatterns(e))return!0;if(!r.existsSync(this.claudeMdPath)){let t=this.getDefaultClaudeMd();r.writeFileSync(this.claudeMdPath,t)}return await this.syncPatternFiles(),c.window.showInformationMessage("CodeBakers patterns initialized!"),!0}catch(t){return console.error("Error initializing patterns:",t),c.window.showErrorMessage(`Failed to initialize patterns: ${t}`),!1}}async downloadPatterns(e){try{let t=await fetch("https://codebakers.ai/api/patterns/download",{method:"GET",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});if(!t.ok)throw new Error(`Server returned ${t.status}`);let s=await t.json();if(s.claudeMd&&r.writeFileSync(this.claudeMdPath,s.claudeMd),s.modules&&Array.isArray(s.modules))for(let a of s.modules){let n=f.join(this.claudeFolderPath,a.name);r.writeFileSync(n,a.content)}return await this.syncPatternFiles(),c.window.showInformationMessage(`Downloaded ${s.modules?.length||0} pattern modules`),!0}catch(t){return console.error("Error downloading patterns:",t),!1}}async updatePatterns(e){let t=await this.downloadPatterns(e);return t?c.window.showInformationMessage("Patterns updated successfully!"):c.window.showWarningMessage("Failed to update patterns from server"),t}async openClaudeMd(){if(r.existsSync(this.claudeMdPath)){let e=await c.workspace.openTextDocument(this.claudeMdPath);await c.window.showTextDocument(e)}else c.window.showWarningMessage('CLAUDE.md not found. Run "CodeBakers: Initialize Patterns" first.')}getDefaultClaudeMd(){return`# CodeBakers - MCP-First Development

## MANDATORY: Two Gates (NON-NEGOTIABLE)

You MUST call these MCP tools. You are NOT ALLOWED to skip them.

### Gate 1: BEFORE Writing ANY Code

\`\`\`
discover_patterns({ task: "description of what you're building", keywords: ["relevant", "keywords"] })
\`\`\`

This tool returns the patterns you MUST follow. Read them carefully.

### Gate 2: BEFORE Saying "Done"

\`\`\`
validate_complete({ feature: "feature name", files: ["path/to/files.ts"] })
\`\`\`

This tool checks:
- Tests exist and pass
- TypeScript compiles
- Patterns were followed

You are NOT ALLOWED to say "done" until this passes.

---

## Rules

1. **NEVER** write code without calling \`discover_patterns\` first
2. **NEVER** say "done" without calling \`validate_complete\` first
3. **ALWAYS** follow the patterns returned by the tools exactly
4. **ALWAYS** write tests for new functionality
5. **NEVER** skip error handling or loading states

## What The Tools Do

| Tool | When | What It Does |
|------|------|--------------|
| \`discover_patterns\` | Before coding | Searches codebase, returns relevant patterns |
| \`validate_complete\` | Before "done" | Runs tests, checks types, verifies compliance |

## Quick Reference

\`\`\`
User asks for feature
    \u2193
Call discover_patterns \u2192 Read the patterns
    \u2193
Write code following patterns exactly
    \u2193
Write tests
    \u2193
Call validate_complete \u2192 Must pass
    \u2193
ONLY THEN say "done"
\`\`\`

---

That's it. The MCP tools handle everything else.
`}checkPatternHealth(){let e=this.getStatus(),t=[],s=100;if(!e.hasClaudeMd)t.push({severity:"critical",title:"No Pattern File",message:"CLAUDE.md not found. AI tools have no rules to follow.",action:"Initialize Patterns",actionCommand:"codebakers.initPatterns"}),s-=50;else try{let n=r.readFileSync(this.claudeMdPath,"utf-8");n.trim().length<100&&(t.push({severity:"high",title:"Minimal Patterns",message:"CLAUDE.md is nearly empty. AI has very few rules to follow.",action:"Update Patterns",actionCommand:"codebakers.updatePatterns"}),s-=30),["MUST","ALWAYS","NEVER","REQUIRED","MANDATORY","NOT ALLOWED","NON-NEGOTIABLE"].some(k=>n.toUpperCase().includes(k))||(t.push({severity:"medium",title:"Weak Enforcement Language",message:"CLAUDE.md lacks strong enforcement words (MUST, ALWAYS, NEVER). AI may ignore soft suggestions.",action:"Open CLAUDE.md",actionCommand:"codebakers.openClaudeMd"}),s-=15),n.includes("discover_patterns")||n.includes("validate_complete")||(t.push({severity:"medium",title:"No Gate Enforcement",message:"No MCP tool gates found. Consider adding discover_patterns and validate_complete.",action:"Update Patterns",actionCommand:"codebakers.updatePatterns"}),s-=10),n.includes("pre-commit")||n.includes("validate-codebakers")||(t.push({severity:"low",title:"No Pre-Commit Validation",message:"No pre-commit hook configured. Non-compliant code can be committed.",action:"Open CLAUDE.md",actionCommand:"codebakers.openClaudeMd"}),s-=5)}catch(n){console.error("Error reading CLAUDE.md:",n)}if(!e.inSync&&e.hasClaudeMd&&(t.push({severity:"high",title:"Files Out of Sync",message:"CLAUDE.md and .cursorrules differ. One AI tool may have different rules.",action:"Sync Now",actionCommand:"codebakers.syncPatterns"}),s-=20),(!e.hasClaudeFolder||e.patternCount===0)&&(t.push({severity:"medium",title:"No Pattern Modules",message:"No .claude/ folder or modules. Full CodeBakers patterns not installed.",action:"Update Patterns",actionCommand:"codebakers.updatePatterns"}),s-=10),e.lastUpdated){let n=new Date(e.lastUpdated),l=(Date.now()-n.getTime())/(1e3*60*60*24);l>30&&(t.push({severity:"low",title:"Patterns May Be Outdated",message:`Patterns last updated ${Math.floor(l)} days ago. Consider updating.`,action:"Update Patterns",actionCommand:"codebakers.updatePatterns"}),s-=5)}s=Math.max(0,Math.min(100,s));let a;return s>=80?a="strong":s>=60?a="moderate":s>=30?a="weak":a="none",{score:s,warnings:t,enforceability:a}}createFileWatcher(){let e=c.workspace.createFileSystemWatcher(new c.RelativePattern(this.workspaceRoot,"{CLAUDE.md,.cursorrules,.claude/**}"));return e.onDidChange(()=>{console.log("Pattern file changed")}),e.onDidCreate(()=>{console.log("Pattern file created")}),e.onDidDelete(()=>{console.log("Pattern file deleted")}),e}};var d=p(require("vscode")),C=class{constructor(e){this.refreshInterval=null;this.lastHealth=null;this.warningShownThisSession=!1;this.patternManager=e,this.statusBarItem=d.window.createStatusBarItem(d.StatusBarAlignment.Right,100),this.statusBarItem.command="codebakers.showMenu",this.update(),this.statusBarItem.show(),this.refreshInterval=setInterval(()=>this.update(),3e4),setTimeout(()=>this.checkAndShowWarnings(),2e3)}update(){let e=this.patternManager.getStatus();this.lastHealth=this.patternManager.checkPatternHealth();let t=this.lastHealth,s,a;t.enforceability==="none"||t.enforceability==="weak"?(s="$(error)",a=new d.ThemeColor("statusBarItem.errorBackground")):t.enforceability==="moderate"?(s="$(warning)",a=new d.ThemeColor("statusBarItem.warningBackground")):(s="$(check)",a=void 0);let n=e.patternCount>0?` [${e.patternCount}]`:"",l=` ${t.score}%`;this.statusBarItem.text=`${s} CodeBakers${n}${l}`,this.statusBarItem.tooltip=this.buildHealthTooltip(e,t),this.statusBarItem.backgroundColor=a}buildHealthTooltip(e,t){let s={critical:"\u{1F534}",high:"\u{1F7E0}",medium:"\u{1F7E1}",low:"\u{1F535}"},a={strong:"\u2705 Strong - AI will likely follow rules",moderate:"\u26A0\uFE0F Moderate - AI may sometimes ignore rules",weak:"\u274C Weak - AI will likely ignore rules",none:"\u{1F6AB} None - No patterns to enforce"},n=[`CodeBakers Pattern Health: ${t.score}%`,"",a[t.enforceability],"",`CLAUDE.md: ${e.hasClaudeMd?"\u2713":"\u2717"}`,`.cursorrules: ${e.hasCursorRules?"\u2713":"\u2717"}`,`Modules: ${e.patternCount}`,`In sync: ${e.inSync?"\u2713":"\u2717"}`];if(t.warnings.length>0){n.push("","--- Warnings ---");for(let l of t.warnings.slice(0,3))n.push(`${s[l.severity]} ${l.title}`);t.warnings.length>3&&n.push(`... and ${t.warnings.length-3} more`)}return n.push("","Click for options"),n.join(`
`)}checkAndShowWarnings(){if(this.warningShownThisSession)return;let t=this.patternManager.checkPatternHealth().warnings.filter(s=>s.severity==="critical"||s.severity==="high");if(t.length>0){this.warningShownThisSession=!0;let s=t[0],a=`CodeBakers: ${s.title} - ${s.message}`;s.action?d.window.showWarningMessage(a,s.action,"Show All Warnings").then(n=>{n===s.action&&s.actionCommand?d.commands.executeCommand(s.actionCommand):n==="Show All Warnings"&&this.showWarnings()}):d.window.showWarningMessage(a,"Show All Warnings").then(n=>{n==="Show All Warnings"&&this.showWarnings()})}}async showWarnings(){let e=this.lastHealth||this.patternManager.checkPatternHealth();if(e.warnings.length===0){d.window.showInformationMessage("No pattern warnings. Your setup looks good!");return}let t={critical:"\u{1F534} CRITICAL",high:"\u{1F7E0} HIGH",medium:"\u{1F7E1} MEDIUM",low:"\u{1F535} LOW"},s=e.warnings.map(n=>({label:`${t[n.severity]}: ${n.title}`,description:n.action||"",detail:n.message}));s.unshift({label:`Pattern Health Score: ${e.score}%`,description:`Enforceability: ${e.enforceability}`,detail:`${e.warnings.length} issue(s) found`,kind:d.QuickPickItemKind.Separator});let a=await d.window.showQuickPick(s,{placeHolder:"Pattern Warnings - Select to fix",title:`CodeBakers Pattern Health: ${e.score}%`});if(a&&a.description){let n=e.warnings.find(l=>l.action===a.description);n?.actionCommand&&await d.commands.executeCommand(n.actionCommand)}}async showMenu(){let e=this.patternManager.getStatus(),t=[];e.hasClaudeMd||t.push({label:"$(add) Initialize Patterns",description:"Create CLAUDE.md and .cursorrules"}),e.hasClaudeMd&&!e.inSync&&t.push({label:"$(sync) Sync Pattern Files",description:"Sync CLAUDE.md to .cursorrules"}),e.hasClaudeMd&&t.push({label:"$(file) Open CLAUDE.md",description:"View and edit patterns"}),t.push({label:"$(cloud-download) Update Patterns",description:"Download latest patterns from server"}),t.push({label:"$(refresh) Refresh Status",description:"Check pattern file status"}),t.push({label:"$(info) Pattern Status",description:`${e.patternCount} modules loaded`});let s=this.lastHealth||this.patternManager.checkPatternHealth();s.warnings.length>0&&t.unshift({label:`$(alert) Show Warnings (${s.warnings.length})`,description:`Health: ${s.score}% - ${s.enforceability} enforcement`});let a=await d.window.showQuickPick(t,{placeHolder:"CodeBakers Options"});if(a){if(a.label.startsWith("$(alert) Show Warnings")){await this.showWarnings();return}switch(a.label){case"$(add) Initialize Patterns":await d.commands.executeCommand("codebakers.initPatterns");break;case"$(sync) Sync Pattern Files":await d.commands.executeCommand("codebakers.syncPatterns");break;case"$(file) Open CLAUDE.md":await d.commands.executeCommand("codebakers.openClaudeMd");break;case"$(cloud-download) Update Patterns":await d.commands.executeCommand("codebakers.updatePatterns");break;case"$(refresh) Refresh Status":this.update(),d.window.showInformationMessage("Pattern status refreshed");break;case"$(info) Pattern Status":this.showStatusInfo();break}}}showStatusInfo(){let e=this.patternManager.getStatus(),t=[`CLAUDE.md: ${e.hasClaudeMd?"Found":"Not found"}`,`.cursorrules: ${e.hasCursorRules?"Found":"Not found"}`,`Pattern modules: ${e.patternCount}`,`Files in sync: ${e.inSync?"Yes":"No"}`].join(" | ");d.window.showInformationMessage(t)}dispose(){this.refreshInterval&&clearInterval(this.refreshInterval),this.statusBarItem.dispose()}};var m,u,v;function W(o){console.log("CodeBakers: activate() called - v2.0.0 (Pattern Manager)"),v=o,m=new y,u=new C(m),$(o);let e=m.createFileWatcher();e.onDidChange(()=>u.update()),e.onDidCreate(()=>u.update()),e.onDidDelete(()=>u.update()),o.subscriptions.push(e),o.subscriptions.push({dispose:()=>u.dispose()});let t=m.getStatus();!t.hasClaudeMd&&!t.hasCursorRules?i.window.showInformationMessage("CodeBakers: No patterns found. Initialize patterns to enable AI rule enforcement.","Initialize Patterns").then(s=>{s==="Initialize Patterns"&&i.commands.executeCommand("codebakers.initPatterns")}):t.inSync||i.window.showInformationMessage("CodeBakers: Pattern files are out of sync.","Sync Now").then(s=>{s==="Sync Now"&&i.commands.executeCommand("codebakers.syncPatterns")}),console.log("CodeBakers: Extension activated successfully")}function $(o){o.subscriptions.push(i.commands.registerCommand("codebakers.showMenu",()=>{u.showMenu()})),o.subscriptions.push(i.commands.registerCommand("codebakers.initPatterns",async()=>{await m.initializePatterns(),u.update()})),o.subscriptions.push(i.commands.registerCommand("codebakers.syncPatterns",async()=>{await m.syncPatternFiles(),u.update()})),o.subscriptions.push(i.commands.registerCommand("codebakers.updatePatterns",async()=>{let e=await D();if(!e){i.window.showWarningMessage("API key required to download patterns. Get one at codebakers.ai","Get API Key").then(t=>{t==="Get API Key"&&i.env.openExternal(i.Uri.parse("https://codebakers.ai/dashboard"))});return}await m.updatePatterns(e),u.update()})),o.subscriptions.push(i.commands.registerCommand("codebakers.openClaudeMd",async()=>{await m.openClaudeMd()})),o.subscriptions.push(i.commands.registerCommand("codebakers.refreshStatus",()=>{u.update(),i.window.showInformationMessage("CodeBakers: Status refreshed")})),o.subscriptions.push(i.commands.registerCommand("codebakers.showWarnings",()=>{u.showWarnings()})),o.subscriptions.push(i.commands.registerCommand("codebakers.openChat",()=>{i.window.showInformationMessage("CodeBakers now works with Claude Code and Cursor directly! Your CLAUDE.md rules are automatically applied.","Learn More").then(e=>{e==="Learn More"&&i.env.openExternal(i.Uri.parse("https://codebakers.ai/docs/integration"))})})),console.log("CodeBakers: All commands registered")}async function D(){let e=i.workspace.getConfiguration("codebakers").get("apiKey");if(e||(e=await v.secrets.get("codebakers.apiKey")||null,e))return e;let t=await i.window.showInputBox({prompt:"Enter your CodeBakers API key (press Escape to skip and use default patterns)",placeHolder:"cb_xxxxxxxxxxxxxxxx (optional)",password:!0,ignoreFocusOut:!1});return t?(await v.secrets.store("codebakers.apiKey",t),t):null}function F(){console.log("CodeBakers: deactivate() called")}0&&(module.exports={activate,deactivate});
